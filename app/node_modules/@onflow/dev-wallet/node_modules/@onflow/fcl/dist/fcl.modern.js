import{config as e}from"@onflow/config";export{config}from"@onflow/config";import{resolve as t,resolveRefBlockId as n,resolveParams as a,resolveArguments as r,resolveAccounts as s,resolveSignatures as o,resolveValidators as i,build as c,send as u,decodeResponse as l,getTransactionStatus as d,getLatestBlock as f,getEvents as p,getAccount as y}from"@onflow/sdk";export{arg,args,authorization,authorizations,build,cadence,cdc,getAccount,getBlockByHeight,getBlockById,getEvents,getLatestBlock,getTransactionStatus,isBad,isOk,limit,param,params,payer,ping,pipe,proposer,ref,script,transaction,why}from"@onflow/sdk";import{subscriber as h,spawn as m,snapshoter as w,INIT as g,SUBSCRIBE as E,UPDATED as S,UNSUBSCRIBE as b,SNAPSHOT as T,send as R}from"@onflow/util-actor";import{Identity as I}from"@onflow/types";e().put("accessNode.api","http://localhost:8080").put("challenge.handshake","http://localhost:8700/authenticate");const v=async c=>t(c,[n({node:await e().get("accessNode.api")}),a,r,s,o,i]),P=async(t=[],n={})=>(n.node=n.node||await e().get("accessNode.api"),Array.isArray(t)&&(t=c(t)),u(await v(t),n)),k=async(e=[])=>(Array.isArray(e)&&(e=await c(e)),JSON.stringify(await v(e))),N=async t=>{const n=await e().where(/^decoder\./),a=Object.fromEntries(Object.entries(n).map(([e,t])=>[e=`/${e.replace(/^decoder\./,"")}$/`,t]));return l(t,a)},A=async e=>{const t=await P([d(e)]);return N(t)},O=e=>e.status>=4,L=e=>e.status>=3,C=e=>e.status>=2,U={[g]:async e=>{const t=await A(e.self());O(t)||setTimeout(()=>e.sendSelf("POLL"),2500),e.merge(t)},[E]:(e,t)=>{e.subscribe(t.from),e.send(t.from,S,e.all())},[b]:(e,t)=>{e.unsubscribe(t.from)},[T]:async(e,t)=>{t.reply(e.all())},POLL:async e=>{const t=await A(e.self());var n,a;O(t)||setTimeout(()=>e.sendSelf("POLL"),2500),n=e.all(),a=t,JSON.stringify(n)!==JSON.stringify(a)&&e.broadcast(S,t),e.merge(t)}},x=e=>{if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},D=e=>m(U,x(e));function _(e){function t(t){return h(x(e),D,t)}function n(e){return function(n={}){const a=n.suppress||!1;return new Promise((n,r)=>{const s=t(t=>{t.statusCode&&!a?(r(t.errorMessage),s()):e(t)&&(n(t),s())})})}}return{snapshot:function(){return w(e,D)},subscribe:t,onceFinalized:n(C),onceExecuted:n(L),onceSealed:n(O)}}_.isUnknown=e=>e.status>=0,_.isPending=e=>e.status>=1,_.isFinalized=C,_.isExecuted=L,_.isSealed=O,_.isExpired=e=>5===e.status;const z=async()=>N(await P([f()])),F=async t=>setTimeout(()=>t.sendSelf("TICK"),await e().get("fcl.eventPollRate",1e4)),j={TICK:async e=>{if(!e.hasSubs())return;let t=e.get("hwm");if(null==t)e.put("hwm",await z()),e.put("tick",await F(e));else{let n=await z();e.put("hwm",n);const a=await P([p(e.self(),t.height,n.height-1)]),r=await N(a);for(let t of r)e.broadcast("UPDATED",t.data);e.put("tick",await F(e))}},[E]:async(e,t)=>{e.hasSubs()||e.put("tick",await F(e)),e.subscribe(t.from)},[b]:(e,t)=>{e.unsubscribe(t.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))}},M=e=>m(j,e);function B(e){return{subscribe:t=>h(e,M,t)}}function J(e){return null==e?null:e.replace(/^0x/,"")}function H(e){return null==e?null:"0x"+J(e)}function $(e){if(document.getElementById("FCL_IFRAME"))return;const t=document.createElement("iframe");return t.src=e,t.id="FCL_IFRAME",t.allow="usb",t.style.position="fixed",t.style.top="0px",t.style.right="0px",t.style.left="0px",t.style.bottom="0px",t.style.height="100vh",t.style.width="100vw",t.style.display="block",t.style.background="rgba(0,0,0,0.25)",t.frameBorder="0",t.style.boxSizing="border-box",t.style.border="1px solid white",document.body.append(t),[t,()=>{document.getElementById("FCL_IFRAME")&&document.getElementById("FCL_IFRAME").remove()}]}async function V(e,t){if(null==e||null==t)return[];const n=new URL(e);n.searchParams.append("code",t);const a=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json());if(Array.isArray(a))return a;const r=[];if(Array.isArray(a.authorizations))for(let e of a.authorizations)r.push({type:"authz",keyId:a.keyId,...e});return null!=a.provider&&r.push({type:"authn",id:"wallet-provider#authn",...a.provider}),r}function G(e=[],t=[]){return[...e,...t]}function q(e,t=!0){const n=new URL(e.endpoint);if(t)for(let[t,a]of Object.entries(e.params||{}))n.searchParams.append(t,a);return n}function W(e){return $(q(e).href)}const K={"HTTP/GET":"GET","HTTP/POST":"POST"},X=e=>new Promise(async(t,n)=>{const a=await fetch(q(e),{method:K[e.method],headers:{"Content-Type":"application/json"}}).then(e=>e.json());"APPROVED"===a.status?t(a.compositeSignature):"DECLINED"===a.status?n({status:a.status,reason:a.reason}):setTimeout(()=>{t(X(a.authorizationUpdates))},500)}),Q=(e,t)=>null==t?`'${e}'`:`'${e}' (${t})`,Y=(e,t)=>`Missing ${Q(e,t)} in Composite Signature.`,Z=(e,t)=>`${Q(e,t)} in Composit Signature did not match the requested ${e}.`;var ee="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",te=ee.length;const ne={"HTTP/POST":async function(e,t){var n=()=>{},a=null;try{const r=await fetch(q(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t?JSON.stringify(t):void 0}).then(e=>e.json());if(r.local&&r.local.length>0){const[e,t]=W(r.local[0]);n=t}a=await X(r.authorizationUpdates)}catch(a){throw n(),ae(e,t,a),a}finally{return n(),a}},"IFRAME/RPC":async function(e,t){return new Promise((n,a)=>{try{const r=function(){for(var e="",t=32;t--;)e+=ee[Math.random()*te|0];return e}(),[s,o]=W(e);setTimeout(()=>{s.contentWindow.postMessage(JSON.parse(JSON.stringify({jsonrpc:"2.0",id:r,method:"fcl:sign",params:[t,e.params]})),"*")},500);const i=async({data:e})=>{if("object"!=typeof e)return;if("2.0"!==e.jsonrpc)return;if(e.id!==r)return;const t=e.result;"APPROVED"===t.status?(window.removeEventListener("message",i),o(),n(t.compositeSignature)):"DECLINED"===t.status?(window.removeEventListener("message",i),o(),a({status:t.status,reason:t.reason})):(window.removeEventListener("message",i),o(),a({status:"DECLINED",reason:"Status was neither APPROVED nor DECLINED"}))};window.addEventListener("message",i)}catch(n){ae(e,t,n),a({status:"DECLINED",reason:"Trouble talking to Wallet Provider"})}})}};function ae(e,t,n){console.error(`[${e.method}] Trouble talking to Wallet Provider`,"\n\n",{authz:e,signable:t},n)}const re="CURRENT_USER",se="CURRENT_USER/UPDATED",oe='{\n  "VERSION": "0.2.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "services":[]\n}',ie=async e=>(localStorage.setItem(re,JSON.stringify(e)),e),ce={[g]:async e=>{e.merge(await(async()=>{const e=JSON.parse(oe),t=JSON.parse(localStorage.getItem(re));return null!=t&&e.VERSION!==t.VERSION?(localStorage.removeItem(re),e):t||e})())},[E]:(e,t)=>{e.subscribe(t.from),e.send(t.from,se,e.all())},[b]:(e,t)=>{e.unsubscribe(t.from)},SNAPSHOT:async(e,t)=>{t.reply(e.all())},SET_CURRENT_USER:async(e,t,n)=>{e.merge(n),ie(e.all()),e.broadcast(se,e.all())},DEL_CURRENT_USER:async(e,t)=>{e.merge(JSON.parse(oe)),ie(e.all()),e.broadcast(se,e.all())},GET_AS_PARAM:async(e,t,{key:n})=>{t.reply({key:n,value:e.get("addr",null),xform:I})}},ue=()=>m(ce,re);async function le(){return new Promise(async t=>{ue();const n=await he();if(n.loggedIn)return t(n);const[a,r]=function({handshake:e,l6n:t}){var n=new URL(e);return n.searchParams.append("l6n",t),$(n.href)}({handshake:await e().get("challenge.handshake"),l6n:window.location.origin}),s=async({data:e})=>{if("FCL::CHALLENGE::RESPONSE"!==e.type)return;r(),window.removeEventListener("message",s);const n={addr:e.addr,cid:"did:fcl:"+e.addr,loggedIn:!0,services:G(e.services||[],await V(e.hks,e.code))};R(re,"SET_CURRENT_USER",n),t(await he())};window.addEventListener("message",s)})}function de(){ue(),R(re,"DEL_CURRENT_USER")}async function fe(e){ue();const t=function(e=[],t){return e.find(e=>e.type===t)}((await le()).services,"authz");let n;return e.role.proposer&&(n=(await async function(){ue();const{addr:e}=await he();if(null==e)throw new Error("No Flow Address for Current User");const{account:t}=await P([y(e)]);return t}()).keys.find(e=>e.index===t.keyId).sequenceNumber),{...e,addr:t.addr,keyId:t.keyId,sequenceNum:n,signature:e.signature||null,signingFunction:async e=>async function(e,t){const n=await ne[e.method](e,t);return null==n.sig&&(n.sig=n.signature),null==n.signature&&(n.signature=n.sig),function(e,t){try{if(null==e.addr)throw new Error(Y("addr","Address"));if(null==e.keyId)throw new Error(Y("keyId"));if(null==e.signature)throw new Error(Y("signature"));if(e.addr!==t.addr)throw new Error(Z("addr","Address"));if(e.keyId!==t.keyId)throw new Error(Z("keyId"))}catch(n){throw console.error(n,"\n\n",{"Composite Signature":e,"Authz Service":t}),new Error("Composite Signature from Wallet Provider failed Validation/Sanitation.\nReason: "+n.message)}}(n,e),n}(t,e),resolve:null,roles:e.roles}}function pe(e){return async function(){return ue(),await le(),R(re,"GET_AS_PARAM",{key:e},{expectReply:!0,timeout:10})}}function ye(e){ue();const t=m(async t=>{for(t.send(re,E);;){const n=await t.receive();if("@EXIT"===n.tag)return void t.send(re,b);e(n.data)}});return()=>R(t,"@EXIT")}function he(){return ue(),R(re,"SNAPSHOT",null,{expectReply:!0,timeout:0})}const me=()=>({authenticate:le,unauthenticate:de,authorization:fe,param:pe,subscribe:ye,snapshot:he}),we=()=>me().authenticate(),ge=()=>me().unauthenticate(),Ee="0.0.56";export{Ee as VERSION,we as authenticate,me as currentUser,N as decode,B as events,v as resolve,J as sansPrefix,P as send,k as serialize,_ as tx,ge as unauthenticate,H as withPrefix};
//# sourceMappingURL=fcl.modern.js.map
